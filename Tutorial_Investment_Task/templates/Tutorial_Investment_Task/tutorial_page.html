{% extends "Tutorial_Investment_Task/Page.html" %}
{% load otree static %}

{% block title %}
    Investment decision experiment
{% endblock %}

{% block content %}
    <div class="welcome_page content" id="content_welcome_page">
        <p>
            Welcome to this Experiment.
            It will take around 1 hour to complete and you will have the option to earn an additional bonus payment
            depending on your performance.
            This is the tutorial part of the experiment, where you will be shown how to make your investments,
            how the asset you're investing in works, how you will be asked about your expectations, and how this
            all affects the bonus payment at the end.
{#            TODO (After Pilot): Mention Quizz and training rounds#}
        </p>
        <p>
            Please try to stay focused during the whole experiment and do not leave this browser window.
            If possible, complete the study in the fullscreen mode of your browser.
            To enter fullscreen mode on windows, press the <i><b>F11</b></i> key on your keyboard.
            If you are using a Mac you can press <i><b>Cmd + Ctrl + F</b></i>.
        </p>
        <p>
            Lastly before we start, there are rare cases in which browsers can load scripts in the wrong order
            or have other "hiccups" which would prevent you from continuing.
            If you ever become stuck or think that something is wrong, you can always reload the page (in most
            browsers this can be done using the <i><b>F5</b></i> key).
        </p>
        <p>
            Please click the continue button to start the tutorial.
        </p>
        <button class="button btn continue_button navigation_button" id="welcome_continue_button" type="button"
                onclick="flip_tut_pages('continue')">Continue</button>
    </div>

    <div class="trading_tutorial content" id="content_trading_tutorial" style="display: none;">
        <h4>Making investment decisions</h4>
        <div class="instr_text tut_part_1" id="instr_text_1">
            <p>
                In this experiment you will make investment decisions in {{ n_blocks }} blocks of either
                {{ n_rounds_per_block_list.0 }} or {{ n_rounds_per_block_list.1 }} rounds each.
                There will be an asset you can invest in. At the start of a block, the asset will always
                have a value of {{ start_price }} Points. In each round you can decide how many shares of this asset
                you want to hold. You can hold a maximum of {{ max_hold }} shares and a minimum of {{ min_hold }}.
                How holding negative shares works will be explained in the following pages.
            </p>
            <p>
                Below you can see the screen with which you will interact during the task. The different columns
                are described here. Please make sure you have looked at each row and understood its meaning before
                proceeding.
            </p>
            <ul>
                <li><b>Column I:</b>
                    Shows how many shares of the asset you are holding. '+3' thus means you are holding three
                    shares and each price movement will affect the value of your portfolio by three times the
                    movement. If this collumn shows '0' this means you are not holding any shares and
                    the value of your portfolio (which in this case would be purely cash) is not affected
                    by the next price movement.</li>
                <li><b>Column II:</b>
                    This column shows the average buying price of your shares. If the current price is above
                    this value, your investment will have made a profit. It will be reset whenever you sell all
                    your shares, or switch from short selling (holding negative shares) to holding shares or
                    vice versa.</li>
                <li><b>Column III:</b>
                    This column shows the current price of the asset. If you decide to buy or sell in this round,
                    this is the price at which the asset will be bought or sold.
                    How this price develops over time will be explained later.</li>
                <li><b>Column IV:</b>
                    This column shows your returns for this investment (how much value your investment has
                    gained or lost). The value in parenthesis shows the same idea in percentages, where 100% would
                    mean you have doubled your investment and -50% means it has lost half its value.</li>
                <li><b>Column V:</b>
                    This column shows the current values in your portfolio. It shows your cash, the value of the
                    assets you are holding (i.e. its price times the amount of assets) and the total amount.</li>
            </ul>
            <p>
                Beneath the table you can find the interface with which you can make your trades.
                To make yourself familiar with the process, please <b>buy two shares now</b> by entering '2'
                in the field and clicking the 'Buy' button. Once you have done that, you can confirm that order
                by clicking the 'Confirm' button. <br>
                Once you have done that the text will continue here and you will be able to scroll down.
            </p>
        </div>

        <div class="instr_text tut_part_2" id="instr_text_2" style="display: none;">
            <hr>
            <p>
                Very good. You now doubled your investment from holding two to holding four shares of the asset.
                The value of the purchased shares was subtracted from the cash field.
            </p>
            <p>
                To keep you on track with the time there will be a blinking warning after {{ max_time }} seconds
                in the task to tell you to make a decision. If you make your decisions before this warning appears, you
                will be able to finish the experiment in the recommended time. However, don't let this put any
                presure on you. After some rounds {{ max_time }} seconds will be enough time to make a well considered
                decision.
{#                TODO (After Pilot): Talk about trying it out in the training rounds#}
            </p>
            <div id="timer_warning_field">
            <p class="blink_text">
                This is what the warning will look like: "Please decide now!"
            </p>
            </div>
            <p>
                After deciding on your trade you will see an update about the price for {{ update_time }} seconds.
                How these updates are decided will be described on the following page. This is what such an update
                could look like:
            </p>
            <div class="price_update_text example_box" id="price_update_text">
                <p class="price_update_paragraph">
                    The price of the asset <b>increases</b> by <b>5</b> and is now
                        <span id="new_value" style="font-weight: bold;"></span>
                </p>
            </div>
            <p>
                Please take some time to look at how the table has changed, now that you bought additional shares
                and the price has moved.
            </p>
            <p>
                If you have understood everything so far, sell all your shares by entering the amount of shares you are
                holding and klicking on the "Sell" button.
            </p>
        </div>

        <div class="content trade_interface" id="id_trade_interface">
        <!--    trading information table-->
            <table class = "trade_info_table" id="trade_info_table" style="text-align:center; width: 100%">
                <tr>
                    <th></th>
                    <th>I</th>
                    <th>II</th>
                    <th>III</th>
                    <th>IV</th>
                    <th>V</th>
                </tr>
                <tr style="background: darkgrey">
                    <th></th>
                    <th>Shares</th>
                    <th>Average Buying Price</th>
                    <th>Current Price</th>
                    <th>Returns (in %)</th>
                    <th>Total Value</th>
                </tr>
                <tr class="table_content">
                    <td><b>Cash</b></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td id="id_cash">{{ start_cash }}</td>
                </tr>
                <tr class="table_content">
                    <td><b>Asset</b></td>
                    <td id="id_hold">2</td>
                    <td id="id_baseprice">{{start_price}}</td>
                    <td id="id_price">{{start_price}}</td>
                    <td id="id_return">0 (0.0)</td>
                    <td id="id_value">{{ start_price_twice }}</td>
                </tr>
                <tr style="background: skyblue;">
                    <td><b>Total</b></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td id="id_value_all" style="font-weight: bold">{{start_cash}}</td>
                </tr>
            </table>
            <br>
            <hr>
            <!--    order forms-->
            <p>You are deciding how to invest for the <b>next period</b>.</p>
            <div id="order_buttons">
                {% include 'investment_task/trading_forms.html' %}
            </div>
        </div>

        <button class="button btn continue_button navigation_button" id="trade_continue_button" type="button"
            style="display: none" onclick="flip_tut_pages('continue')">Continue</button>
    </div>

    <div class="shorting_tutorial content" id="content_shorting_tutorial" style="display: none;">
        <h4>Short selling</h4>
        <div class="instr_text tut_part_3" id="instr_text_3">
            <p>
                When investing a profit is made by buying an asset as cheaply as possible and selling it for as much
                as possible. However, the order in which those actions are taken do not play a role.
                This means you can sell shares that you do not own yet, usually by borrowing them from a third person
                (in this case this would be the experiments bank, lending you the shares you need). You then "owe"
                these shares, which is why it is displayed as negative shares in the interface. This is what is called
                "short selling".
            </p>
            <p>
                Imagine having sold one share (that you borrowed from the bank) for 100 points.
                You will have received these 100 points in cash, but you also still have to buy one share to give
                back to the bank. When short selling you thus make a profit when the price of the asset
                <b>decreases</b>, because then you can buy the asset back for cheaper than what you have sold it for.
            </p>
            <p>
                Imagine now that in our example the price drops by 20 points. You are now able to buy one share for
                80 points and return it to the bank. Having received 100 points earlier and spent 80 points now,
                you have made a profit of 20 points. On the other hand this means that a price increase is <b>not</b>
                favorable when you have short sold the asset, since you would then have to spend more money to buy
                it back than what you sold it for.
            </p>
            <p>
                If you think that you have understood this principle, please look at the table below (which has been
                reset to holding 2 shares) and <i>sell four shares</i>, thus selling two more shares than you currently
                have. The tutorial will then continue here.
            </p>
        </div>

        <div class="instr_text tut_part_4" id="instr_text_4" style="display: none;">
            <hr>
            <p>
                You receive the following price update:
            </p>
            <div class="price_update_text example_box" id="price_update_text2">
                <p class="price_update_paragraph">
                    The price of the asset <b>decreases</b> by <b>5</b> and is now
                        <span id="new_value2" style="font-weight: bold;"></span>
                </p>
            </div>
            <p>
                As you can see, the "Shares" column now shows negative two shares. The average buying price is now
                displayed as the average price at which you made your short sales. As you can see from the price
                update, the price of the asset has <b>decreased</b>, which is favorable for your short sale investment.
                This is also reflected in the "Returns" column, which shows a positive return. When short selling, the
                dependence of your returns on the price movements is therefore reversed from that of a
                standard investment.
            </p>
            <p>
                In summary, you should <b>buy</b> shares when you expect the price to <b>increase</b> and
                <b>short sell</b> the asset when you expect the price to <b>decrease</b>.
                You are also free to "jump" from holding shares to short selling shares and vice versa at any time.
            </p>
            <p>
                To continue please make an order such that you will hold 5 shares.
            </p>
        </div>

        <div class="content trade_interface" id="id_trade_interface2">
        <!--    trading information table-->
            <table class = "trade_info_table" id="trade_info_table2" style="text-align:center; width: 100%">
                <tr style="background: darkgrey">
                    <th></th>
                    <th>Shares</th>
                    <th>Average Buying Price</th>
                    <th>Current Price</th>
                    <th>Returns (in %)</th>
                    <th>Total Value</th>
                </tr>
                <tr class="table_content">
                    <td><b>Cash</b></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td id="id_cash2">{{ start_cash }}</td>
                </tr>
                <tr class="table_content">
                    <td><b>Asset</b></td>
                    <td id="id_hold2">2</td>
                    <td id="id_baseprice2">{{start_price}}</td>
                    <td id="id_price2">{{start_price}}</td>
                    <td id="id_return2">0 (0.0)</td>
                    <td id="id_value2">{{ start_price_twice}} </td>
                </tr>
                <tr style="background: skyblue;">
                    <td><b>Total</b></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td id="id_value_all2" style="font-weight: bold">{{start_cash}}</td>
                </tr>
            </table>
            <br>
            <hr>
            <p>You are deciding how to invest for the <b>next period</b>.</p>
            <!--    order forms-->
            <div id="order_forms_content">
                <div class="row">
                    <div class="col-md-9" id="trading_form">
                        <div class="row">
                        <span style="margin-right: 10px">Your Order: </span>
                        <div class="form-group">
                            <div class="controls  field-transaction">
                                <input type="number" name="transaction2" id="id_transaction2" class="form-control">
                            </div>
                        </div>
                        <button class="btn trade_button buy_button" id="asset_buy_button" type="button"
                                onclick="buy()">Buy</button>
                        <button class="btn trade_button sell_button" id="asset_sell_button" type="button"
                                onclick="sell()">Sell</button>
                        </div>
                    </div>
                    <div class="col-md-9" id="confirm_form" style="display: none;">
                        <p id="confirm_text" style="display: inline; font-weight: bold">
                            bux X shares
                        </p>
                        <br>
                        <br>
                        <button class="btn change_button" id="change_order_button" type="button"
                                onclick="switch_order_display()">Change Order</button>
                        <button class="btn confirm_button" id="confirm_orders_button" style="display: none;" type="button"
                            onclick="submit_order()">Confirm Order</button>
                    </div>
                </div>
            </div>
        </div>

        <button class="button btn back_button navigation_button" id="shorting_back_button" type="button"
            onclick="flip_tut_pages('back')">Back</button>
        <button class="button btn continue_button navigation_button" id="shorting_continue_button" type="button"
                style="display: none" onclick="flip_tut_pages('continue');">Continue</button>
    </div>

    <div class="markov_tutorial content" id="content_markov_tutorial" style="display: none;">
        <h4>Price development</h4>
        <div class="instr_text tut_part_5" id="instr_text_5">
            <p>
                We now turn to the way in which the assets price can develop.
                To illustrate, imagine that the asset you are buying is a stock that is based on a company which can
                make a profit but can also loose money.
                You will either be able to invest in the stock of a company with <b>{{ good_raise_prob }}%</b>
                probability of a price increase or one with <b>{{ bad_raise_prob }}%</b>.
                Remember that even if you are given the stock from a company where the price is more likely to decrease,
                you can still profit from this by short selling the asset.
            </p>
{#            <p>#}
{#                Below you see one of these possible price paths.#}
{#                TODO (after pilot): implement Highcharts#}
{#            </p>#}
            <p>
                In each period, the price can move by either <b>{{ movements.0 }},
                {{ movements.1 }} or {{ movements.2 }}</b> points. This is true for both increases as well as decreases.
                Which of these magnitudes the next price moves will take on is determined by chance and with equal
                probaility. Thus, whether the price in- or decreases is determined by the kind of asset
                while the magnitude of the change is determined randomly.
            </p>
            <p>
                As an example: Assuming the current price of the asset is 1000 points and the price will increase.
                It is now equally likely that the next price will be {{ example_move.0 }},  {{ example_move.1 }}
                or {{ example_move.2 }}.
            </p>
        </div>
        <div class="instr_text tut_part_6" id="instr_text_6" style="display: none;">
            <hr>
            <p>
                You may have noticed a line of text above the order form on the previous page saying
                <i>"You are deciding how to invest for the <b>next period</b>"</i> (feel free to click back if you
                missed it). This is because you will be investing under many different conditions throughout the
                different rounds. The page that indicates when a new price path is started will also tell you
                what the conditions for the upcoming price path are. Similarly, whenever you are asked to make an
                investment decision, the line below the table will tell you under what conditions you are now investing.
            </p>
                <ul>
                    <li>The first {{ n_rounds_per_phase}} periods will always be "pre-decided", meaning you can only
                        observe the price movement.</li>
                    <li>After that, in some cases you will be able to make a decision for each individual period of the
                        remaining periods.</li>
                    <li>In some cases you will have to make an investment that will then be "fixed" for the next
                        {{ n_rounds_per_phase }} periods (i.e. if you decide to hold 5 shares, you will hold 5 shares
                        throughout the next {{ n_rounds_per_phase }} price movements).</li>
                    <li>There are also price paths in which you can first decide freely and then have to make a decision
                        for the next {{ n_rounds_per_phase }} rounds.</li>
                    <li>In some of the cases in which you can not freely trade you will be informed about the price
                        movements in each period, in others you will only be informed about the price movements
                        after they all already happened.</li>
                </ul>
            <p>
                It therefore makes sense to <b>pay good attention</b> to which decision you are currently making.
            </p>
        </div>

    <button class="button btn back_button navigation_button" id="markov_back_button" type="button"
        onclick="flip_tut_pages('back')">Back</button>
    <button class="button btn continue_button navigation_button" id="markov_continue_button" type="button"
            onclick="check_tutorial_moves('continue', 'markov')">Continue</button>
    </div>

    <div class="belief_tutorial content" id="content_belief_tutorial" style="display: none">
        <h4>Bet and Lottery</h4>
        <div class="instr_text tut_part_7" id="insr_text_7">
            <p>
                Between your trading decisions you will be asked a further question, which will be explained here.
            </p>
            <p>
                In each round there is a <b>lottery</b> in which you can either win {{ lottery_bonus }} or 0
                bonus-points, which will be added to your payoff in the end.
                The probability with which you will receive any points (winning probability) is unknown
                to you. It will be determined randomly and any winning probability between 0% and 100% is equally
                likely.
            </p>
            <p>
                As an alternative to this lottery, you can take a <b>bet</b> on the next price move.
                This bet would look like this:
            </p>
            <div class="lottery_text example_box" id="lottery_explanation_text">
                <p>
                    If the price will increase in the next price update (no matter the amount), you will
                    receive {{ lottery_bonus }} bonus points, which will be added to your payoff in the end.
                </p>
            </div>
            <p>
                Thus, winning in this lottery and winning the bet is worth the same amount of bonus points.
                Your task is now to answer the following question:
            </p>
            <div class="lottery_text example_box" id="belief_question">
                <p>
                    What <i>minimal</i> winning probability would you require the lottery to have for you to prefer
                    the lottery over betting on a price increase?
                </p>
            </div>
            <p>
                In case the hidden winning probability is <i>lower</i> than the requirement you submitted,
                you will automatically bet on a price increase and will receive the bonus points in case
                the price increases. If the winning probability is however <i>equal or greater</i> to the minimum
                you required, the lottery will be played and the bonus points will be allotted to you in case you win.
            </p>
            <p>
                Below you can see the slider with which you can provide your answer. Before clicking on it, you will
                only see a line. Please place the slider on <b>60%</b> and click the "Continue" button.
            </p>
            <div id="slider_container" class = "example_box">
                <label for="belief_slider"></label>
                <span>
                    <i>0%</i>
                    <input type="range" class="slider slider_hidden belief_slider" id="belief_slider"
                                                              style="width: 500px"
                                                              oninput="change_slider_value()">
                    <i>100%</i>
                </span>
                <p>
                    <br>
                    I would prefer to play the lottery if the probability of winning is at least
                    <span id="belief_feedback" style="font-weight: bold">XX</span><b>%</b>.
                </p>
            </div>
        </div>
        <div class="instr_text tut_part_8" id="insr_text_8" style="display: none;">
            <hr>
            <p>Two points are especially important:</p>
            <p>
                <b>Point 1:</b>
                Your answer should only depend on the probability of a price increase.
                Imagine a situation in which you definitely knew that the price would increase. The lottery would
                have to provide a similar guarantee for you receiving {{ lottery_bonus }} bonus points for you
                to not prefer the bet. You therefore should set the slider to 100% in that case. <br>
                If on the other hand you knew that the price will decrease, you would prefer the lottery no matter how
                low its winning probability is. You would therefore set the slider to 0%.
            </p>
            <p>
                During the experiment, you will never be able to be completely sure whether the price will increase
                or decrease. You should therefore use the values between these extremes to express how likely you
                think a price increase is. The more to the left you put the slider, the more certain you are that the price
                will <i>decrease</i>. The further to the right you put the slider, the more certain you are that the
                price will <i>increase</i>.
            </p>
            <p>
                <b>Point 2:</b>
                Providing your true belief about the probability of a price increase will always maximize your chance
                to receive the bonus points. If you provide a value that is <i>too low</i>, there is a chance that
                the lottery will be played, although you would have assumed that you had a higher chance to get
                the bonus points if you had bet on the price. If you provide a value that is <i>too high</i>,
                there is a chance that you will bet on the price increase, although you would have preferred to play
                the lottery, because its winning probability was sufficiently high.
            </p>
            <p>
                To maximize your chances for the bonus points your best act is therefore to always report your
                genuine belief about the probability of a price increase.
            </p>
            <p>
                At the end of the experiment you will receive the points you earned in the trading task,
                as well as {{ lottery_discount }}% of the points you have received in the lottery or betting task.
                This sum will then determine your final payoff.
            </p>
        </div>

        <button class="button btn back_button navigation_button" id="belief_back_button" type="button"
            onclick="flip_tut_pages('back')">Back</button>
        <button class="button btn continue_button navigation_button" id="belief_continue_button" type="button"
                onclick="check_tutorial_moves('continue', 'belief')">Continue</button>
    </div>

    <div class="structure_tutorial content" id="content_structure_tutorial" style="display: none;">
        <h4>Blocks and Payoff</h4>
        <p>
            The task will consist of <b>{{ n_blocks }} price paths</b> to invest in, each of which consisting of
            either {{ n_rounds_per_block_list.0 }} or {{ n_rounds_per_block_list.1 }} rounds.
            Each price path is independent from that before and only determined
            by the probability of a price increase of the given asset.
            You will be informed whenever a new price path starts.
        </p>
        <p>
            After the last round of each block, there will be one last price update. If you are holding any shares
            after this last price update, they will automatically be sold, such that you will only hold cash in the end.
            Similarly any short positions will automatically be bought back. The payoff will be calculated in the
            following way:
        </p>
        <p>
            The payoff will be based on <b>the difference</b> between the value of your portfolio (cash plus assets)
            <i>at the start</i> of each block and the value of your portfolio <i>at the end</i> of the block.
            This therefore reflects the winnings or losses of your investments.
            Additionally, {{ lottery_discount }}% of the points from the lottery and betting task will be counted towards
            this final sum. Your final points will then be added or subtracted from the base payoff of CHF
            {{ base_bonus }}.00 with an exchange rate of {{ conversion_percent }}%.
            Additionally you will receive the {{ showup_fee }} for completing the study, no matter your performance.
            </p>
            <p>
            As an example: <br>
            If your total earnings from all blocks plus {{ lottery_discount }}% of the lottery-points
            adds up to 100 points, your payoff will be {{ example_payoff }}. It will consist from {{ showup_fee }}
            for completing the study, CHF {{ base_bonus }}.00 base payoff plus {{ conversion_percent }}% of the
            100 points you earned.
        </p>
        <p>
            If you have understood these instructions, please click the "Continue" button to start the experiment.
{#            TODO (after pilot): Include training here!#}
        </p>
        <button class="button btn back_button navigation_button" id="structure_back_button" type="button"
            onclick="flip_tut_pages('back')">Back</button>
        <button class="button btn continue_button navigation_button" id="structure_continue_button" type="button"
                onclick="check_tutorial_moves('continue', 'structure')">Continue</button>
    </div>

    <style>
        .example_box{
            margin-left: 5%;
            margin-bottom: 10px;
            padding-left: 20px;
            padding-top: 10px;
            padding-bottom: 1px;
            background: #eeeeee;"
        }

        .btn{
            margin-right: 10px;
        }

        .form-group{
            margin-right: 10px;
        }

        .row {
            margin-bottom: 20px;
        }

        .table_content{
            background: aliceblue;
        }

        /* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
        .slider_hidden::-webkit-slider-thumb {
            visibility: hidden;
        }

        .slider_hidden::-moz-range-thumb {
            visibility: hidden;
        }

        #id_transition_matrix_table td{
            border-color: dimgrey;
        }

        /* Timer style */
        .blink_text {
        animation:1s blinker linear infinite;
        -webkit-animation:1s blinker linear infinite;
        -moz-animation:1s blinker linear infinite;
        color: red;
        font-weight: bold;
        }

        @-moz-keyframes blinker {
            0% { opacity: 1.0; }
            50% { opacity: 0.0; }
            100% { opacity: 1.0; }
        }
        @-webkit-keyframes blinker {
            0% { opacity: 1.0; }
            50% { opacity: 0.0; }
            100% { opacity: 1.0; }
        }
        @keyframes blinker {
            0% { opacity: 1.0; }
            50% { opacity: 0.0; }
            100% { opacity: 1.0; }
        }
    </style>

{% endblock %}