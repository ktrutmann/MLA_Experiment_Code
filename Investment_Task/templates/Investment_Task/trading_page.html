{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    Investitions-Entscheidungen
{% endblock %}

{% block content %}

    <!--timeout warning field-->
    <div id="timer_warning_field" style="visibility: hidden; text-align: right; margin-top: -30px">
        <p class="blink_text" style="align-content: end">
            Bitte entscheiden Sie sich jetzt!
        </p>
    </div>

    <div class="content">
    <!--    trading information table-->
        {% include 'investment_task/trading_table.html' %}
        <br>
        <hr>
        {% include 'investment_task/trading_forms.html' %}

        <input type="hidden" name="changed_mind" id="id_changed_mind" value=0>
        <input type="hidden" name="erroneous_trades" id="id_erroneous_trades" value=0>
        <input id="id_transaction" name="transaction" type="hidden" value="0">
        <input id="id_time_to_order" name="time_to_order" type="hidden" value="0">
        <input id="id_unfocused_time_to_order" name="unfocused_time_to_order" type="hidden" value="0">


    </div> <!-- end content --->

    <style>
    .btn{
        margin-left: 10px;
    }

    .form-group{
        margin-right: 10px;
    }

    .row {
        margin-bottom: 20px;
    }

    .table_content{
        background: aliceblue;
    }

    /* Timer style */
          .blink_text {
            animation:1s blinker linear infinite;
            -webkit-animation:1s blinker linear infinite;
            -moz-animation:1s blinker linear infinite;
            color: red;
            font-weight: bold;
        }
        @-moz-keyframes blinker {
            0% { opacity: 1.0; }
            50% { opacity: 0.0; }
            100% { opacity: 1.0; }
        }
        @-webkit-keyframes blinker {
            0% { opacity: 1.0; }
            50% { opacity: 0.0; }
            100% { opacity: 1.0; }
        }
        @keyframes blinker {
            0% { opacity: 1.0; }
            50% { opacity: 0.0; }
            100% { opacity: 1.0; }
        }
    </style>

    <!--Button logic and order handling happens here><-->
    <script>
        // Some non-jquery jquery handiness:
        $$ = function(x){return document.getElementById(x)};

        //first some layout corrections that oTree wouldn't allow otherwise
        $$("id_transaction").placeholder = "Anzahl";

        // Disable the enter key for this page
        window.addEventListener('keydown',function(e){
            if(e.keyIdentifier === 'U+000A' || e.keyIdentifier === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                return false;
            }
        }, true);

        // Start tracking the time
        window.onload = function(){
            load_time = get_time();
            unfocused_start = get_time();
            unfocused_time = 0;
        };

        // Warning after time has run out
        setTimeout(
            function () {
                $$('timer_warning_field').style.visibility = 'visible'
            },
            parseInt('{{max_time}}')*1000
        );

        // Timetracking
        let load_time = 0;
        let unfocused_time = 0;
        let unfocused_start = 0;

        get_time = function(){
            let timer = new Date();
            return timer.getTime();
        };

        window.onblur = function(){
            unfocused_start = get_time();
        };

        window.onfocus = function(){
            unfocused_time = unfocused_time + (get_time() - unfocused_start);
        };

// Handling orders
    let order_a_given = false;
    let order = 0;

    check_order = function(order){
        let hold = parseInt('{{player.hold_A}}');
        let max_hold = parseInt('{{max_hold}}');
        let cash = parseInt('{{player.cash}}');
        let price = parseInt('{{value_A}}');

        if (hold + order > max_hold ){
            alert('Sie können nicht mehr als ' + max_hold + ' Anteile halten.');
            switch_order_display();
            $$('id_erroneous_trade').value = 'overbought';
            return false;
        } else if (hold + order < 0) {
            alert('Sie haben nur ' + hold + ' Anteile, die Sie verkaufen können.');
            switch_order_display();
            $$('id_erroneous_trade').value = 'oversold';
            return false;
        } else if (Math.max(0, order * price) > cash) {
            {#TODO: Test! This should never happen!#}
            alert('Diese Transaktion kostet leider zu viel.');
            switch_order_display();
            $$('id_erroneous_trade').value = 'not_enough_cash';
            return false;
        }
    }

    switch_order_display = function(){
        if ($$("trading_form").style.display !== 'none'){ // We are looking at the trading form
            $$("trading_form").style.display = 'none';
            $$("confirm_form").style.display = 'inline';
            $$("confirm_orders_button").style.display = "inline";
        } else { // We are looking at the confirmation form
            $$("trading_form").style.display = 'inline';
            $$("confirm_form").style.display = 'none';
            $$("confirm_orders_button").style.display = "none";
            // Make sure no number is displayed in the input field and record the change of mind
            $$('id_transaction').value = '';
            $$('id_changed_mind').value = 1;
        }
    };

    get_order_value = function(action){
        if (isNaN(order)){
            return(0);
        } else if (action === 'sell') {
            return ($$("id_transaction").value * -1)
        } else {
            return ($$("id_transaction").value)
        }
    };

    set_confirm_text = function(amount){
        let action_prefix = ' ';
        if (amount < 0) { action_prefix = ' ver' }
        $$("confirm_text").innerHTML =
        Math.abs(amount) + ' Anteile ' + action_prefix + 'kaufen';
    };

    // Then handle the clicky bits
    buy = function(){
        if (isNaN($$("id_transaction").value)){
            order = 0
        } else{
            order = $$("id_transaction").value
        }
        if(check_order(order)) {
            switch_order_display();
            set_confirm_text(order);
        }
    };

    sell = function(){
        switch_order_display();
        order = get_order_value('sell');
        set_confirm_text(order);
        check_order();
    };

    submit_order = function(){
        $$("id_transaction").value = order;
        $$('id_time_to_order').value = (get_time() - load_time) / 1000;
        $$('id_unfocused_time_to_order').value = unfocused_time / 1000;
        $$('form').submit();
    };

    </script>

{% endblock %}
